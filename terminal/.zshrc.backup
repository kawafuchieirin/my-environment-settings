# Powerlevel10k instant prompt（最上部に配置必須）
# 注意: この設定より前に出力を伴うコマンドを実行してはいけません
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# =============================================================================
# Oh My Zsh 設定
# =============================================================================

export ZSH="$HOME/.oh-my-zsh"

# テーマ: Powerlevel10k
ZSH_THEME="powerlevel10k/powerlevel10k"

# プラグイン
plugins=(
    git
    zsh-autosuggestions
    zsh-syntax-highlighting
    zsh-completions
    fzf
    python
    pip
    virtualenv
    docker
    brew
)

# 補完の初期化（zsh-completions用）
fpath+=${ZSH_CUSTOM:-${ZSH:-~/.oh-my-zsh}/custom}/plugins/zsh-completions/src

source $ZSH/oh-my-zsh.sh

# =============================================================================
# 環境変数
# =============================================================================

export LANG=ja_JP.UTF-8
export EDITOR='vim'

# Homebrew (Apple Silicon対応)
if [[ $(uname -m) == "arm64" ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# =============================================================================
# Python環境 (pyenv)
# =============================================================================
# 注意: pyenvの初期化はインスタントプロンプトの後に配置

export PYENV_ROOT="$HOME/.pyenv"
[[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"

# pyenvの初期化（存在チェック付き）
if command -v pyenv &> /dev/null; then
    eval "$(pyenv init -)"
    # pyenv-virtualenvが利用可能な場合のみ初期化
    if pyenv commands | grep -q virtualenv-init; then
        eval "$(pyenv virtualenv-init -)"
    fi
fi

# =============================================================================
# モダンCLIツール
# =============================================================================

# eza (ls の代替)
if command -v eza &> /dev/null; then
    alias ls='eza --icons --group-directories-first'
    alias ll='eza -l --icons --group-directories-first --git'
    alias la='eza -la --icons --group-directories-first --git'
    alias lt='eza --tree --level=2 --icons'
    alias lta='eza --tree --level=2 --icons -a'
fi

# bat (cat の代替)
if command -v bat &> /dev/null; then
    alias cat='bat --style=plain'
    alias catn='bat'  # 行番号付き
    export MANPAGER="sh -c 'col -bx | bat -l man -p'"
fi

# zoxide (cd の代替)
if command -v zoxide &> /dev/null; then
    eval "$(zoxide init zsh)"
    alias cd='z'
fi

# fzf設定
if command -v fzf &> /dev/null; then
    # ライトテーマ用の配色
    export FZF_DEFAULT_OPTS='
        --height 40%
        --layout=reverse
        --border
        --color=bg+:#e8e8e8,bg:#ffffff,spinner:#0969da,hl:#0550ae
        --color=fg:#24292f,header:#0550ae,info:#57606a,pointer:#0969da
        --color=marker:#1a7f37,fg+:#24292f,prompt:#0969da,hl+:#0550ae
    '
    # ripgrepをデフォルトに
    if command -v rg &> /dev/null; then
        export FZF_DEFAULT_COMMAND='rg --files --hidden --follow --glob "!.git/*"'
    fi
fi

# =============================================================================
# エイリアス
# =============================================================================

# Git
alias g='git'
alias gs='git status'
alias ga='git add'
alias gc='git commit'
alias gp='git push'
alias gl='git log --oneline --graph'
alias gd='git diff'
alias lg='lazygit'

# delta設定（git diffの美化）
if command -v delta &> /dev/null; then
    export GIT_PAGER='delta'
fi

# Python
alias py='python'
alias py3='python3'
alias pip='pip3'
alias venv='python -m venv'
alias activate='source .venv/bin/activate'

# ディレクトリ操作
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias mkdir='mkdir -p'

# 安全策
alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'

# その他
alias c='clear'
alias h='history'
alias grep='grep --color=auto'

# 新しいツール
alias tl='tldr'  # コマンドの使い方を簡潔に表示
alias j='jq'     # JSONパーサー

# =============================================================================
# 関数
# =============================================================================

# 新しいPythonプロジェクトを作成
mkpy() {
    if [ -z "$1" ]; then
        echo "Usage: mkpy <project-name>"
        return 1
    fi
    mkdir -p "$1"
    cd "$1"
    python -m venv .venv
    source .venv/bin/activate
    echo "# $1" > README.md
    echo ".venv/" > .gitignore
    echo "__pycache__/" >> .gitignore
    echo "*.pyc" >> .gitignore
    echo ".env" >> .gitignore
    git init
    echo "Pythonプロジェクト '$1' を作成しました"
}

# ディレクトリ作成して移動
mkcd() {
    mkdir -p "$1" && cd "$1"
}

# fzfでファイルを選択してvimで開く
fv() {
    local file
    file=$(fzf --preview 'bat --style=numbers --color=always {}')
    [ -n "$file" ] && vim "$file"
}

# fzfでディレクトリを選択して移動
fd() {
    local dir
    dir=$(find . -type d 2>/dev/null | fzf --preview 'eza --tree --level=1 {}')
    [ -n "$dir" ] && cd "$dir"
}

# =============================================================================
# Powerlevel10k設定（自動生成される）
# =============================================================================

[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
